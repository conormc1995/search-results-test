"use strict";
/**
 * Copyright Microsoft Corporation. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const debug = require("debug");
exports.errorLog = { name: 'generic', severity: 'error' };
exports.apiLog = { name: 'api', color: 'cyan' };
function logError(logger) {
    return error => logger._log(exports.errorLog, error, []);
}
exports.logError = logError;
class RootLogger {
    constructor(userSink) {
        this._logger = new MultiplexingLogger();
        if (userSink)
            this._logger.add('user', userSink);
        this._logger.add('debug', new DebugLogger());
    }
    _isLogEnabled(log) {
        return this._logger.isEnabled(log.name, log.severity || 'info');
    }
    _log(log, message, ...args) {
        if (this._logger.isEnabled(log.name, log.severity || 'info'))
            this._logger.log(log.name, log.severity || 'info', message, args, log.color ? { color: log.color } : {});
    }
}
exports.RootLogger = RootLogger;
const colorMap = new Map([
    ['red', 160],
    ['green', 34],
    ['yellow', 172],
    ['blue', 33],
    ['magenta', 207],
    ['cyan', 45],
    ['reset', 0],
]);
class MultiplexingLogger {
    constructor() {
        this._loggers = new Map();
    }
    add(id, logger) {
        this._loggers.set(id, logger);
    }
    get(id) {
        return this._loggers.get(id);
    }
    remove(id) {
        this._loggers.delete(id);
    }
    isEnabled(name, severity) {
        for (const logger of this._loggers.values()) {
            if (logger.isEnabled(name, severity))
                return true;
        }
        return false;
    }
    log(name, severity, message, args, hints) {
        for (const logger of this._loggers.values())
            logger.log(name, severity, message, args, hints);
    }
}
class DebugLogger {
    constructor() {
        this._debuggers = new Map();
    }
    isEnabled(name, severity) {
        return debug.enabled(`pw:${name}`);
    }
    log(name, severity, message, args, hints) {
        let cachedDebugger = this._debuggers.get(name);
        if (!cachedDebugger) {
            cachedDebugger = debug(`pw:${name}`);
            this._debuggers.set(name, cachedDebugger);
            let color = hints.color || 'reset';
            switch (severity) {
                case 'error':
                    color = 'red';
                    break;
                case 'warning':
                    color = 'yellow';
                    break;
            }
            const escaped = colorMap.get(color) || 0;
            if (escaped)
                cachedDebugger.color = String(escaped);
        }
        cachedDebugger(message, ...args);
    }
}
//# sourceMappingURL=logger.js.map